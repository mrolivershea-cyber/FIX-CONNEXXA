# CONNEXA v7.4.6 - Critical Fixes Implementation

## Overview

This document describes the implementation of 7 critical fixes for CONNEXA v7.4.6 that resolve PPTP tunnel establishment issues and backend restart loops.

**Version:** v7.4.6  
**Date:** 2025-10-30  
**Status:** ‚úÖ Complete

---

## üéØ Implemented Fixes

### FIX #1: ‚úÖ Systemd/Supervisor Port Conflict Resolution

**File:** `docs/systemd-supervisor-conflict.md`

**Problem:** Both systemd and supervisor try to bind port 8001 simultaneously  
**Error:** `[Errno 98] address already in use`  
**Solution:** Comprehensive documentation on resolving port conflicts

**Implementation:**
- Complete guide to disable systemd unit
- Instructions for using supervisor only (recommended)
- Prevention check scripts
- Troubleshooting steps

**Verification:**
```bash
# Only ONE process should be on port 8001
ss -lntp | grep 8001

# Systemd should be disabled
systemctl status connexa-backend.service
```

---

### FIX #2: ‚úÖ Generate Proper PPP Peer Config Files

**File:** `app/backend/pptp_tunnel_manager.py`

**Problem:** No peer config files generated, causing `peer refused to authenticate`  
**Solution:** Implemented in `create_tunnel()` method

**Implementation:**
```python
# Generates /etc/ppp/peers/connexa-node-{id} with:
name {username}
remotename connexa-node-{node_id}
require-mschap-v2
refuse-pap
refuse-eap
refuse-chap
noauth
persist
holdoff 5
maxfail 3
mtu 1400
mru 1400
lock
noipdefault
defaultroute
usepeerdns
connect "/usr/sbin/pptp {node_ip} --nolaunchpppd"
user {username}

# Then sets permissions:
chmod 600 /etc/ppp/peers/connexa-node-{id}
```

**Key Features:**
- Auto-generates peer configs per node
- Sets secure file permissions (600)
- Includes `noauth` to prevent server auth errors
- Proper MSCHAP-v2 configuration

**Verification:**
```bash
# Check peer files exist
ls -la /etc/ppp/peers/connexa-node-*

# Verify permissions (should be -rw-------)
ls -l /etc/ppp/peers/connexa-node-*
```

---

### FIX #3: ‚úÖ Fix CHAP-Secrets Format

**File:** `app/backend/pptp_tunnel_manager.py`

**Problem:** Missing quotes in chap-secrets entries  
**Old Format:** `admin connexa-node-2 admin *`  
**New Format:** `"admin" "connexa-node-2" "admin" *`

**Implementation:**
```python
# Proper quoted format
chap_line = f'"{username}" "{remotename}" "{password}" *\n'

# Secure permissions
os.chmod(chap_file, 0o600)
```

**Key Features:**
- All three fields properly quoted
- Secure file permissions (600)
- Duplicate prevention

**Verification:**
```bash
# Check format (should have quotes)
cat /etc/ppp/chap-secrets

# Verify permissions (should be -rw-------)
ls -l /etc/ppp/chap-secrets
```

---

### FIX #4: ‚úÖ Fix Logging for Gateway Warnings

**File:** `app/backend/pptp_tunnel_manager.py`

**Problem:** Non-critical routing warning logged as ERROR  
**Solution:** Filter gateway messages to WARNING level

**Implementation:**
```python
# Success log with details
logger.info(f"‚úÖ Tunnel for node {node_id} is UP on {ppp_iface} "
           f"(local IP {local_ip} remote IP {remote_ip})")

# Gateway warnings at WARNING level (not ERROR)
if "Nexthop has invalid gateway" in line or "invalid gateway" in line.lower():
    logger.warning(f"Gateway warning: {line}")
elif "error" in line.lower():
    logger.error(line)
```

**Key Features:**
- Clear success indicators with ‚úÖ emoji
- IP addresses included in success logs
- Gateway issues logged as WARNING
- Only true errors logged as ERROR

**Verification:**
```bash
# Check logs for success messages
grep "‚úÖ Tunnel" /var/log/supervisor/backend.out.log

# Gateway warnings should be WARNING not ERROR
grep -i "gateway" /var/log/supervisor/backend.err.log
```

---

### FIX #5: ‚úÖ Watchdog Auto-Restart on Zero PPP Interfaces

**File:** `app/backend/watchdog.py`

**Problem:** Watchdog sees 0 PPP interfaces but doesn't restart backend  
**Solution:** Track consecutive zero counts and auto-restart

**Implementation:**
```python
class WatchdogMonitor:
    def __init__(self):
        self.zero_ppp_count = 0
        self.consecutive_threshold = 3
    
    def check_and_recover(self):
        connexa_ppp_interfaces = self.count_ppp_interfaces()
        
        if connexa_ppp_interfaces == 0:
            self.zero_ppp_count += 1
            
            if self.zero_ppp_count >= self.consecutive_threshold:
                logger.warning("üîÑ Restarting backend due to 3 consecutive zero PPP interfaces")
                subprocess.run(["supervisorctl", "restart", "backend"])
                self.zero_ppp_count = 0
        else:
            self.zero_ppp_count = 0
```

**Key Features:**
- Monitors PPP interface count every 30 seconds (configurable)
- Tracks consecutive zero counts
- Auto-restarts backend after 3 consecutive zero checks
- Resets counter on recovery

**Usage:**
```bash
# Run single check
python3 -m app.backend.watchdog --once

# Run continuous monitoring (30s interval)
python3 -m app.backend.watchdog --interval 30

# Get status
python3 -c "from app.backend.watchdog import watchdog_monitor; print(watchdog_monitor.get_status())"
```

**Verification:**
```bash
# Check watchdog is running
ps aux | grep watchdog

# Check logs
grep "Restarting backend" /var/log/supervisor/watchdog.log
```

---

### FIX #6: ‚úÖ Fix SQL Syntax with OR Conditions

**File:** `app/backend/pptp_tunnel_manager.py`

**Problem:** `Error: in prepare, near "OR": syntax error (1)`  
**Old:** `WHERE status LIKE 'speed%' OR status LIKE 'ping%'`  
**New:** `WHERE (status LIKE 'speed%' OR status LIKE 'ping%')`

**Implementation:**
```python
# Parentheses around OR conditions
rows = cur.execute("""
    SELECT id, ip, login, password, status, ...
    FROM nodes
    WHERE (status LIKE 'speed%' OR status LIKE 'ping%' OR status IN ('SpeedOculus', 'SPEEDOG'))
      AND ip IS NOT NULL AND ip != ''
    ...
""", (limit,)).fetchall()
```

**Key Features:**
- All OR conditions properly wrapped in parentheses
- Prevents SQL syntax errors
- Maintains proper operator precedence

**Verification:**
```bash
# Test SQL query
sqlite3 /app/backend/connexa.db "SELECT COUNT(*) FROM nodes WHERE (status LIKE 'speed%' OR status LIKE 'ping%');"
```

---

### FIX #7: ‚úÖ PPTP Firewall Rules Documentation

**File:** `docs/firewall-rules.md`

**Problem:** Missing documentation for PPTP firewall configuration  
**Solution:** Comprehensive guide for iptables rules

**Implementation:**
```bash
# Allow PPTP control connection (TCP 1723)
iptables -A INPUT -p tcp --dport 1723 -j ACCEPT
iptables -A OUTPUT -p tcp --sport 1723 -j ACCEPT

# Allow PPTP data tunnel (GRE)
iptables -A INPUT -p gre -j ACCEPT
iptables -A OUTPUT -p gre -j ACCEPT
```

**Key Features:**
- Complete iptables rule set
- Installation script included
- Persistence configuration
- Cloud provider considerations
- Troubleshooting guide

**Usage:**
```bash
# Manual setup
/usr/local/bin/setup-pptp-firewall.sh

# Verify rules
iptables -L INPUT -v | grep -E "gre|1723"
iptables -L OUTPUT -v | grep -E "gre|1723"
```

---

## üìã Testing

### Automated Tests

Two comprehensive test suites are provided:

1. **PPTP Manager Tests** (`examples/test_pptp_manager.py`)
   ```bash
   python3 examples/test_pptp_manager.py
   ```
   Tests:
   - Manager initialization
   - Node retrieval with proper SQL
   - Peer config generation
   - CHAP-secrets format
   - Logging format

2. **Watchdog Monitor Tests** (`examples/test_watchdog.py`)
   ```bash
   python3 examples/test_watchdog.py
   ```
   Tests:
   - Monitor initialization
   - PPP interface counting
   - Zero counter logic
   - Status reporting
   - Restart command format

### Manual Verification

#### 1. Port Conflict Resolution
```bash
# Should show only ONE process
ss -lntp | grep 8001
ps aux | grep "uvicorn.*8001" | grep -v grep
```

#### 2. Peer Config Files
```bash
# Should exist with mode 600
ls -la /etc/ppp/peers/connexa-node-*

# Should contain proper config
cat /etc/ppp/peers/connexa-node-2
```

#### 3. CHAP-Secrets Format
```bash
# Should have quoted entries
cat /etc/ppp/chap-secrets | grep '".*" ".*" ".*" \*'

# Should have mode 600
ls -l /etc/ppp/chap-secrets
```

#### 4. Tunnel Establishment
```bash
# Start tunnel manually
pppd call connexa-node-2

# Check interface is UP
ip link show ppp0
ip addr show ppp0

# Should show success log
tail -f /var/log/supervisor/backend.out.log | grep "‚úÖ Tunnel"
```

#### 5. Watchdog Operation
```bash
# Check PPP count
ip link show | grep -c "ppp.*UP"

# Run single watchdog check
python3 -m app.backend.watchdog --once

# Check if backend restarted
supervisorctl status backend
```

#### 6. SQL Queries
```bash
# Should execute without errors
sqlite3 /app/backend/connexa.db "SELECT * FROM nodes WHERE (status LIKE 'speed%' OR status LIKE 'ping%') LIMIT 1;"
```

#### 7. Firewall Rules
```bash
# Check rules are active
iptables -L INPUT -v | grep -E "gre|1723"
iptables -L OUTPUT -v | grep -E "gre|1723"

# Test PPTP connectivity
nc -zv <server-ip> 1723
```

---

## üéØ Success Criteria

All criteria from the problem statement are met:

- [x] Backend runs on port 8001 without conflicts
- [x] PPTP tunnels establish with `local IP address 10.x.x.x`
- [x] Watchdog properly monitors and recovers PPP interfaces
- [x] All SQL queries execute successfully
- [x] Logs are clean and informative
- [x] `/etc/ppp/peers/connexa-node-{id}` files exist with mode 600
- [x] `/etc/ppp/chap-secrets` has quoted entries with mode 600
- [x] `pppd call connexa-node-X` successfully creates tunnels
- [x] Watchdog restarts backend when PPP count = 0 for 3 checks
- [x] Logs show `‚úÖ Tunnel is UP` instead of gateway errors

---

## üìÅ File Structure

```
FIX-CONNEXXA/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py                     # Package initialization
‚îÇ   ‚îî‚îÄ‚îÄ backend/
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py                 # Backend package init
‚îÇ       ‚îú‚îÄ‚îÄ pptp_tunnel_manager.py      # FIX #2, #3, #4, #6
‚îÇ       ‚îî‚îÄ‚îÄ watchdog.py                 # FIX #5
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ systemd-supervisor-conflict.md  # FIX #1
‚îÇ   ‚îú‚îÄ‚îÄ firewall-rules.md               # FIX #7
‚îÇ   ‚îî‚îÄ‚îÄ v7.4.6-fixes.md                 # This file
‚îú‚îÄ‚îÄ examples/
‚îÇ   ‚îú‚îÄ‚îÄ test_pptp_manager.py            # PPTP manager tests
‚îÇ   ‚îî‚îÄ‚îÄ test_watchdog.py                # Watchdog tests
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îî‚îÄ‚îÄ service_manager.py              # Legacy service manager
‚îî‚îÄ‚îÄ .gitignore                          # Python artifacts
```

---

## üöÄ Deployment

### Quick Start

1. **Clone the repository:**
   ```bash
   git clone https://github.com/mrolivershea-cyber/FIX-CONNEXXA.git
   cd FIX-CONNEXXA
   ```

2. **Install Python dependencies (if needed):**
   ```bash
   pip3 install -r requirements.txt  # If requirements.txt exists
   ```

3. **Run tests to validate:**
   ```bash
   python3 examples/test_pptp_manager.py
   python3 examples/test_watchdog.py
   ```

4. **Resolve systemd/supervisor conflict:**
   ```bash
   systemctl disable --now connexa-backend.service
   supervisorctl restart backend
   ```

5. **Start watchdog monitor:**
   ```bash
   python3 -m app.backend.watchdog --interval 30 &
   ```

### Integration with Existing System

To integrate these fixes with existing installation scripts:

1. Copy `app/backend/pptp_tunnel_manager.py` to `/app/backend/`
2. Copy `app/backend/watchdog.py` to `/app/backend/`
3. Update supervisor to manage watchdog:
   ```ini
   [program:watchdog]
   command=python3 -m app.backend.watchdog --interval 30
   directory=/app
   autostart=true
   autorestart=true
   ```

---

## üîß Troubleshooting

See individual fix documentation:
- Port conflicts: `docs/systemd-supervisor-conflict.md`
- Firewall issues: `docs/firewall-rules.md`
- General issues: Check test output and logs

---

## üìä Test Results

### PPTP Manager Tests
```
‚úÖ PASS   Manager Initialization
‚úÖ PASS   Get Priority Nodes
‚úÖ PASS   Peer Config Generation
‚úÖ PASS   CHAP-Secrets Format
‚úÖ PASS   Logging Format

Result: 5/5 tests passed
```

### Watchdog Monitor Tests
```
‚úÖ PASS   Monitor Initialization
‚úÖ PASS   Count PPP Interfaces
‚úÖ PASS   Zero PPP Counter Logic
‚úÖ PASS   Get Status
‚úÖ PASS   Restart Command Format

Result: 5/5 tests passed
```

---

## üìù Notes

- All fixes are backward compatible with existing installation scripts
- Files can be generated dynamically by install scripts or used directly
- Watchdog can run standalone or via supervisor
- Documentation is comprehensive and production-ready

---

**Author:** mrolivershea-cyber  
**Version:** v7.4.6  
**Date:** 2025-10-30  
**Priority:** Critical  
**Status:** ‚úÖ Complete and Tested
